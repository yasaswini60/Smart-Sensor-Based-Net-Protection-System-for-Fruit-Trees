import React, { useState, useEffect } from 'react';

// === DATA TYPES AND ENUMS ===
enum NetStatus {
  Retracted = 'RETRACTED',
  Deploying = 'DEPLOYING',
  Deployed = 'DEPLOYED',
  Retracting = 'RETRACTING',
  Error = 'ERROR',
}

interface SystemState {
  windSpeed: number;
  netStatus: NetStatus;
  fruitsCollected: number;
  batteryLevel: number;
}

// === DASHBOARD COMPONENT ===
const Dashboard: React.FC = () => {
  const [state, setState] = useState<SystemState>({
    windSpeed: 5,
    netStatus: NetStatus.Retracted,
    fruitsCollected: 0,
    batteryLevel: 98,
  });
  const [alert, setAlert] = useState<string | null>(null);

  const windThreshold = 25; // km/h

  // Simulate changing wind speed and battery level
  useEffect(() => {
    const windInterval = setInterval(() => {
      setState(prevState => ({
        ...prevState,
        // Wind changes randomly, but stays reasonable
        windSpeed: Math.max(0, Math.min(45, prevState.windSpeed + (Math.random() - 0.5) * 5)),
        // Battery slowly drains
        batteryLevel: Math.max(0, prevState.batteryLevel - 0.05),
      }));
    }, 2000);
    return () => clearInterval(windInterval);
  }, []);

  // Main system logic for net deployment and fruit collection
  useEffect(() => {
    // 1. Deploy net if wind is high and it's currently retracted
    if (state.windSpeed > windThreshold && state.netStatus === NetStatus.Retracted) {
      setState(prevState => ({ ...prevState, netStatus: NetStatus.Deploying }));
      setAlert(`CRITICAL WIND ALERT: Wind speed at ${state.windSpeed.toFixed(1)} km/h. Deploying net...`);
      // Simulate deployment delay
      setTimeout(() => setState(prevState => ({ ...prevState, netStatus: NetStatus.Deployed })), 3000);
    }

    // 2. Retract net if wind subsides and net is deployed
    if (state.windSpeed < windThreshold - 5 && state.netStatus === NetStatus.Deployed) {
       handleRetractNet();
    }

    // 3. Simulate fruit falling when net is deployed
    if (state.netStatus === NetStatus.Deployed) {
        const fruitFallInterval = setInterval(() => {
            setState(prevState => ({
                ...prevState,
                fruitsCollected: prevState.fruitsCollected + Math.floor(Math.random() * 3),
            }));
        }, 1500);
        return () => clearInterval(fruitFallInterval); // Cleanup previous interval
    }
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [state.windSpeed, state.netStatus]); // Only re-run logic when these states change

  const handleConfirmCollection = () => {
    if (state.netStatus !== NetStatus.Deployed) return;

    setAlert(`Collection confirmed. ${Math.floor(state.fruitsCollected)} fruits harvested.`);
    setState(prevState => ({ ...prevState, fruitsCollected: 0 }));
    handleRetractNet();
  };

  const handleRetractNet = () => {
     if (state.netStatus !== NetStatus.Deployed) return;
      setState(prevState => ({ ...prevState, netStatus: NetStatus.Retracting }));
      setAlert('Wind has subsided. Retracting net...');
      // Simulate retraction delay
      setTimeout(() => setState(prevState => ({ ...prevState, netStatus: NetStatus.Retracted, fruitsCollected: 0 })), 3000);
  }

  // Determine indicator colors
  const windColor = state.windSpeed > windThreshold ? 'red' : state.windSpeed > windThreshold - 10 ? 'orange' : 'green';
  const batteryColor = state.batteryLevel < 20 ? 'red' : state.batteryLevel < 40 ? 'orange' : 'green';
  const netColorMap: Record<NetStatus, string> = {
    [NetStatus.Retracted]: 'gray',
    [NetStatus.Deploying]: 'orange',
    [NetStatus.Deployed]: 'green',
    [NetStatus.Retracting]: 'orange',
    [NetStatus.Error]: 'red',
  };

  return (
    <div>
      <h1>Automated Orchard Protection System üçé</h1>
      <div className="dashboard-grid">
        <p>Wind Speed: <span style={{ color: windColor, fontWeight: 'bold' }}>{state.windSpeed.toFixed(1)} km/h</span></p>
        <p>Net Status: <span style={{ color: netColorMap[state.netStatus], fontWeight: 'bold' }}>{state.netStatus}</span></p>
        <p>Fruits Collected: <span>{Math.floor(state.fruitsCollected)}</span></p>
        <p>Battery: <span style={{ color: batteryColor, fontWeight: 'bold' }}>{state.batteryLevel.toFixed(1)}%</span></p>
      </div>
      {alert && <div className="alert">{alert}</div>}
      <button onClick={handleConfirmCollection} disabled={state.netStatus !== NetStatus.Deployed || state.fruitsCollected === 0}>
        {state.netStatus === NetStatus.Deployed ? `Confirm & Retract (${Math.floor(state.fruitsCollected)} Fruits)` : 'Confirm Collection'}
      </button>
      <div style={{ marginTop: '20px', fontSize: '14px', color: '#aaa' }}>
        *Net automatically deploys above {windThreshold} km/h and retracts below {windThreshold - 5} km/h.
      </div>
    </div>
  );
};

// === MAIN APP COMPONENT ===
function App() {
  return (
    <div className="App">
      <Dashboard />
      {/* Styles for the entire app */}
      <style>{`
        :root {
          font-family: Inter, system-ui, Avenir, Helvetica, Arial, sans-serif;
          line-height: 1.5;
          font-weight: 400;
          color-scheme: light dark;
          background-color: #242424;
        }
        
        body {
          margin: 0;
          display: flex;
          place-items: center;
          min-width: 320px;
          min-height: 100vh;
          padding: 20px;
        }
        
        #root {
          max-width: 800px;
          margin: 0 auto;
          padding: 2rem;
          text-align: center;
          border: 1px solid #4a4a4a;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
          color: #a0ff80;
        }
        
        .dashboard-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 15px;
          margin-bottom: 25px;
          padding: 15px;
          border: 1px solid #333;
          border-radius: 5px;
          background-color: #1a1a1a;
        }
        
        p {
          background-color: #333;
          padding: 10px;
          border-radius: 4px;
          margin: 0;
          text-align: left;
          color: #fff;
        }
        
        .alert {
          padding: 10px;
          margin: 15px 0;
          background-color: #ffc107;
          color: #333;
          border-radius: 4px;
          font-weight: bold;
        }
        
        button {
          padding: 10px 20px;
          font-size: 16px;
          cursor: pointer;
          background-color: #4CAF50;
          color: white;
          border: none;
          border-radius: 4px;
          transition: background-color 0.3s;
        }
        
        button:hover:not(:disabled) {
          background-color: #45a049;
        }
        
        button:disabled {
          background-color: #555;
          cursor: not-allowed;
        }
      `}</style>
    </div>
  );
}

export default App;
